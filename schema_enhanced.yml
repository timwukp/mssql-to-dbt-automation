version: 2

# Source definitions
sources:
  - name: mssql_source
    description: "Source tables from MSSQL database migration"
    tables:
      - name: customers
        description: "Customer master data"
        columns:
          - name: customer_id
            description: "Unique customer identifier"
            tests:
              - unique
              - not_null
          - name: customer_name
            description: "Customer full name"
            tests:
              - not_null
          - name: region
            description: "Geographic region"
            tests:
              - not_null
              - accepted_values:
                  values: ['US', 'EU', 'APAC']
          - name: created_at
            description: "Customer creation timestamp"
            tests:
              - not_null
      
      - name: orders
        description: "Order transaction data"
        columns:
          - name: order_id
            description: "Unique order identifier"
            tests:
              - unique
              - not_null
          - name: customer_id
            description: "Reference to customer"
            tests:
              - not_null
              - relationships:
                  to: source('mssql_source', 'customers')
                  field: customer_id
          - name: order_amount
            description: "Order total amount"
            tests:
              - not_null
              - dbt_utils.accepted_range:
                  min_value: 0
          - name: order_date
            description: "Order placement date"
            tests:
              - not_null
      
      - name: inventory
        description: "Product inventory data"
        columns:
          - name: product_id
            description: "Unique product identifier"
            tests:
              - unique
              - not_null
          - name: current_stock
            description: "Current stock level"
            tests:
              - not_null
              - dbt_utils.accepted_range:
                  min_value: 0
          - name: warehouse_id
            description: "Warehouse identifier"
            tests:
              - not_null

# Model definitions
models:
  - name: customer_analytics_fixed
    description: "Customer analytics model converted from MSSQL procedure sp_customer_analytics"
    columns:
      - name: customer_id
        description: "Unique customer identifier"
        tests:
          - unique
          - not_null
      - name: customer_name
        description: "Customer full name"
        tests:
          - not_null
      - name: region
        description: "Customer geographic region"
        tests:
          - not_null
          - accepted_values:
              values: ['US', 'EU', 'APAC']
      - name: total_orders
        description: "Total number of orders placed by customer"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      - name: total_revenue
        description: "Total revenue generated by customer"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      - name: avg_order_value
        description: "Average order value for customer"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      - name: days_since_last_order
        description: "Days since customer's last order"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
  
  - name: inventory_management_fixed
    description: "Inventory management model converted from MSSQL procedure sp_inventory_management"
    columns:
      - name: product_id
        description: "Unique product identifier"
        tests:
          - unique
          - not_null
      - name: product_name
        description: "Product name"
        tests:
          - not_null
      - name: current_stock
        description: "Current stock level"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      - name: stock_status
        description: "Current stock status"
        tests:
          - not_null
          - accepted_values:
              values: ['In Stock', 'Low Stock', 'Out of Stock']
  
  - name: sales_reporting_fixed
    description: "Sales reporting model converted from MSSQL procedure sp_sales_reporting"
    columns:
      - name: sales_year
        description: "Sales year"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 2020
              max_value: 2030
      - name: sales_month
        description: "Sales month"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
              max_value: 12
      - name: region
        description: "Sales region"
        tests:
          - not_null
          - accepted_values:
              values: ['US', 'EU', 'APAC']
      - name: monthly_revenue
        description: "Total revenue for the month"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      - name: avg_order_value
        description: "Average order value for the month"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

# Macro definitions
macros:
  - name: validate_region_access
    description: "Validates user access to regional data"
  - name: apply_regional_filter
    description: "Applies regional filtering to queries"
  - name: get_incremental_filter
    description: "Generates incremental loading filters"